{% extends 'base.html' %}
{% block content %}

<div class="container">

    <h2 class="mt-3">Manage Items</h2>
    <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-primary mb-3">
        <i class="bi bi-arrow-left"></i> Back
    </a>

    <!-- Filters Box -->
    <div class="card p-3 shadow-sm mb-4">
        <form id="filterForm" method="GET" class="row g-2">

            <!-- Search -->
            <div class="col-md-4">
                <input type="text" name="search" id="searchBox" class="form-control"
                       placeholder="Search title, owner, email..."
                       value="{{ search }}">
            </div>

            <!-- Category -->
            <div class="col-md-3">
                <select name="category" id="categoryFilter" class="form-select">
                    <option value="">All Categories</option>
                    {% for c in categories %}
                        <option value="{{ c.category }}"
                                {% if selected_category == c.category %}selected{% endif %}>
                            {{ c.category }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Status -->
            <div class="col-md-3">
                <select name="status" id="statusFilter" class="form-select">
                    <option value="">All Status</option>
                    <option value="active" {% if selected_status == 'active' %}selected{% endif %}>Active</option>
                    <option value="scheduled" {% if selected_status == 'scheduled' %}selected{% endif %}>Scheduled</option>
                    <option value="expired" {% if selected_status == 'expired' %}selected{% endif %}>Expired</option>
                </select>
            </div>

        </form>
    </div>


    <!-- Items Table -->
    <table class="table table-hover table-striped">
        <thead>
            <tr>
                <th>S.No</th>
                <th>Item</th>
                <th>Owner</th>
                <th>Category</th>
                <th>Price</th>
                <th>Status</th>
                <th>Expires</th>
                <th>Posted</th>
                <th>Actions</th>
            </tr>
        </thead>

        <tbody>
            {% for i in items %}
            <tr>
                <td>{{ loop.index }}</td>

                <td>
                    <img src="{{ url_for('static', filename='uploads/items/' ~ i.thumbnail) }}"
                         width="50" height="50" class="rounded me-2">
                    <strong>{{ i.title }}</strong>
                </td>

                <td>
                    {{ i.owner_name }}<br>
                    <small>{{ i.owner_email }}</small>
                </td>

                <td>{{ i.category }}</td>

                <td>{{ i.currency }} {{ 'Free' if (i.price is not none and (i.price == 0.0 or i.price == 0)) else i.price }}</td>

                <td>
                    {% if i.computed_status == 'active' %}
                        <span class="badge bg-success">Active</span>
                    {% elif i.computed_status == 'scheduled' %}
                        <span class="badge bg-primary">Scheduled</span>
                    {% else %}
                        <span class="badge bg-secondary">Expired</span>
                    {% endif %}
                </td>

                <td>{{ i.expires_at[:10] }}</td>
                <td>{{ i.created_at[:10] }}</td>

                <td>
                    <button class="btn btn-sm btn-info" data-bs-toggle="modal"
                            data-bs-target="#viewModal{{ i.id }}">
                        <i class="bi bi-eye"></i>
                    </button>

                    <form action="{{ url_for('admin_delete_item', item_id=i.id) }}"
                          method="POST" style="display:inline;"
                          onsubmit="return confirm('Delete this item?');">
                        <button class="btn btn-sm btn-danger">
                            <i class="bi bi-trash"></i>
                        </button>
                    </form>
                </td>
            </tr>

                <!-- View Modal -->
<div class="modal fade" id="viewModal{{ i.id }}" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light border-light">

            <div class="modal-header border-secondary">
                <h5 class="modal-title text-light">{{ i.title }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <!-- IMAGE CAROUSEL -->
                <div id="carousel{{ i.id }}" class="carousel slide mb-3" data-bs-ride="carousel">
                    <div class="carousel-inner">

                        {% if i.images %}
                            {% for img in i.images %}
                                <div class="carousel-item {% if loop.first %}active{% endif %}">
                                    <img src="{{ url_for('static', filename='uploads/items/' ~ img) }}"
                                         class="d-block w-100 rounded"
                                         style="height: 380px; object-fit: contain; background: #000;">
                                </div>
                            {% endfor %}
                        {% else %}
                            <!-- Fallback if no images -->
                            <div class="carousel-item active">
                                <img src="{{ url_for('static', filename='uploads/items/' ~ i.thumbnail) }}"
                                     class="d-block w-100 rounded"
                                     style="height: 380px; object-fit: contain; background: #000;">
                            </div>
                        {% endif %}

                    </div>

                    <!-- Carousel Controls -->
                    <button class="carousel-control-prev" type="button" data-bs-target="#carousel{{ i.id }}" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon"></span>
                    </button>

                    <button class="carousel-control-next" type="button" data-bs-target="#carousel{{ i.id }}" data-bs-slide="next">
                        <span class="carousel-control-next-icon"></span>
                    </button>
                </div>

                <!-- ITEM DETAILS -->
                <p><strong class="text-info">Description:</strong> {{ i.description }}</p>
                <p><strong class="text-info">Category:</strong> {{ i.category }}</p>
                <p><strong class="text-info">Price:</strong> {{ i.currency }} 
                    {{ 'Free' if (i.price == 0 or i.price == 0.0) else i.price }}
                </p>
                <p><strong class="text-info">Owner:</strong> {{ i.owner_name }} ({{ i.owner_email }})</p>
                <p><strong class="text-info">Status:</strong> {{ i.computed_status }}</p>
                <p><strong class="text-info">Expires:</strong> {{ i.expires_at }}</p>

            </div>
        </div>
    </div>
</div>


            {% endfor %}
        </tbody>
    </table>

</div>

<!-- Smooth Auto Filter -->
<script>
let timer;
const delay = 300;

document.getElementById("searchBox").addEventListener("input", function () {
    clearTimeout(timer);
    timer = setTimeout(() => {
        document.getElementById("filterForm").submit();
    }, delay);
});

document.getElementById("categoryFilter").addEventListener("change", () => {
    document.getElementById("filterForm").submit();
});

document.getElementById("statusFilter").addEventListener("change", () => {
    document.getElementById("filterForm").submit();
});
</script>

{% endblock %}
