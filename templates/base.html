<!doctype html>
<html lang="en" id="html-root">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Our Community Marketplace</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
      :root {
        --primary-color: #db1d2b;
        --secondary-color: #f47216;
        --dark-color: #231f20;
      }

      body {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }
      main {
        flex: 1 0 auto;
        padding-top: 1rem;
        padding-bottom: 1rem;
      }
      .footer { flex-shrink: 0; }

      .navbar, .footer { background-color: var(--dark-color) !important; }
      .navbar .navbar-brand, .navbar .nav-link, .footer .text-muted { color: #fff !important; }

      body.dark-mode {
        background-color: #121212;
        color: #fff;
      }
      body.dark-mode .card { background-color: #1e1e1e; color: #fff; }
      body.dark-mode .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); }
      body.dark-mode .btn-secondary { background-color: var(--secondary-color); border-color: var(--secondary-color); color: #fff; }

      .theme-toggle { cursor: pointer; }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="{{ url_for('index') }}">Sandbox - Community Marketplace</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto align-items-center">
              <!-- Voice agent button in navbar -->
              <li class="nav-item">
                  <a class="nav-link" href="#" onclick="showVoiceAgent()">
                      <i class="bi bi-mic"></i> Voice Assistant
                  </a>
              </li>
                {% if session.get('user_id') %}
                    {% if session.get('is_admin') %}
                        <!-- üî• ADMIN NAVIGATION -->
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('admin_dashboard') }}"><i class="bi bi-speedometer"></i> Admin Dashboard</a></li>
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
                    {% else %}
                        <!-- üî• NORMAL USER NAVIGATION -->
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('index') }}"><i class="bi bi-house-door"></i> Homepage</a></li>
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('dashboard') }}"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('profile') }}"><i class="bi bi-person-circle"></i> Profile</a></li>
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('chats_inbox') }}"><i class="bi bi-chat-dots"></i> Messages</a></li>
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
                    {% endif %}
                {% else %}
                    <!-- üî• PUBLIC NAVIGATION -->
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('login') }}"><i class="bi bi-box-arrow-in-right"></i> Login</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('register') }}"><i class="bi bi-person-plus"></i> Register</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('admin_login') }}"><i class="bi bi-person-lock"></i> Admin</a></li>
                {% endif %}
                <li class="nav-item ms-2">
                    <span class="theme-toggle btn btn-outline-light btn-sm" onclick="toggleTheme()">üåô</span>
                </li>

            </ul>

        </div>
      </div>
    </nav>

    <main>
      <!-- Flash container: JS will remove this node after 3 seconds (no fade) -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div id="flash-container" class="container mt-2">
            {% for category, msg in messages %}
              <div class="alert alert-{{ category }} mb-2" role="alert">
                {{ msg }}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      {% block content %}{% endblock %}
    </main>

    <footer class="footer mt-auto py-3 bg-dark text-center">
      <div class="container text-center">
        <span class="text-muted">&copy; Sandbox - Community Marketplace</span>
      </div>
    </footer>

    <!-- Add this to your base.html -->
<div id="voice-agent-modal" class="modal fade" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Voice Assistant</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <div id="voice-status" class="mb-3">Ready to listen...</div>
                    <button id="voice-btn" class="btn btn-primary" onclick="toggleVoiceAgent()">
                        <i class="bi bi-mic"></i> <span id="voice-btn-text">Start Voice</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>


<script>

// Enhanced Voice Agent Implementation
class VoiceAgent {
    constructor() {
        this.isListening = false;
        this.commands = {
            // Main navigation
            'dashboard': '/dashboard',
            'home': '/dashboard',
            'my listings': '/my_listings',
            'add item': '/add_item',
            'manage users': '/admin/users',
            'messages': '/chats',
            'profile': '/profile',
            'contact': '/contact',
            'logout': '/logout',
            'login': '/login',
            'register': '/register',
            'help': '/help',
            
            // Marketplace navigation
            'marketplace': '/marketplace',
            'wishlist': '/wishlist',
            'reports': '/admin/reports',
            'admin dashboard': '/admin/dashboard',
            'settings': '/profile',
            
            // Admin functions
            'admin users': '/admin/users',
            'admin items': '/admin/items',
            'admin reports': '/admin/reports',
            'admin dashboard': '/admin/dashboard',
            
            // Chat functions
            'chat': '/chats',
            'inbox': '/chats',
            
            // User functions
            'my profile': '/profile',
            'update profile': '/profile',
            'change password': '/profile',
            
            // Item functions
            'my items': '/my_listings',
            'edit item': '/my_listings',
            'delete item': '/my_listings',
            
            // Other
            'contact seller': '/contact_seller',
            'report item': '/report_item',
            'wishlist': '/wishlist',
            'favorite': '/wishlist'
        };
    }
    
    activate() {
        this.startListening();
    }
    
    startListening() {
        if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
            alert('Voice recognition not supported in your browser. Please use Chrome or Edge.');
            return;
        }
        
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';
        
        recognition.onstart = () => {
            this.isListening = true;
            document.getElementById('voice-status').textContent = "Listening...";
            document.getElementById('voice-btn-text').textContent = "Listening...";
            document.getElementById('voice-btn').classList.add('btn-warning');
            document.getElementById('voice-btn').classList.remove('btn-primary');
        };
        
        recognition.onresult = (event) => {
            const command = event.results[0][0].transcript.toLowerCase();
            document.getElementById('voice-status').textContent = "Processing: " + command;
            
            // Process the command
            this.processCommand(command);
            
            // Stop after processing
            this.stopListening();
        };
        
        recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            this.stopListening();
        };
        
        recognition.onend = () => {
            this.stopListening();
        };
        
        recognition.start();
    }
    
    stopListening() {
        this.isListening = false;
        document.getElementById('voice-btn-text').textContent = "Start Voice";
        document.getElementById('voice-btn').classList.add('btn-primary');
        document.getElementById('voice-btn').classList.remove('btn-warning');
        document.getElementById('voice-status').textContent = "Ready to listen...";
    }
    
    processCommand(command) {
        // Find matching command
        let matchedRoute = null;
        let matchedCommand = null;
        
        // Check for exact matches first
        for (const [key, route] of Object.entries(this.commands)) {
            if (command.includes(key)) {
                matchedRoute = route;
                matchedCommand = key;
                break;
            }
        }
        
        if (matchedRoute) {
            document.getElementById('voice-status').textContent = "Executing: " + matchedCommand;
            setTimeout(() => {
                window.location.href = matchedRoute;
            }, 1000);
        } else {
            document.getElementById('voice-status').textContent = "Command not recognized: " + command;
            setTimeout(() => {
                document.getElementById('voice-status').textContent = "Ready to listen...";
            }, 2000);
        }
    }
}

// Initialize voice agent
const voiceAgent = new VoiceAgent();

// Global functions for easy access
function showVoiceAgent() {
    const modal = new bootstrap.Modal(document.getElementById('voice-agent-modal'));
    modal.show();
}

function toggleVoiceAgent() {
    const btn = document.getElementById('voice-btn');
    const btnText = document.getElementById('voice-btn-text');
    const status = document.getElementById('voice-status');
    
    if (!voiceAgent.isListening) {
        // Start listening
        voiceAgent.startListening();
        btnText.textContent = "Listening...";
        btn.classList.add('btn-warning');
        btn.classList.remove('btn-primary');
        status.textContent = "Listening for commands...";
    } else {
        // Stop listening
        voiceAgent.stopListening();
        btnText.textContent = "Start Voice";
        btn.classList.add('btn-primary');
        btn.classList.remove('btn-warning');
        status.textContent = "Ready to listen...";
    }
}

// Enhanced command processing
function processVoiceCommand(command) {
    // Simple command mapping - you can expand this
    const commands = {
        'dashboard': '/dashboard',
        'home': '/dashboard',
        'my listings': '/my_listings',
        'add item': '/add_item',
        'manage users': '/admin/users',
        'messages': '/chats',
        'profile': '/profile',
        'contact': '/contact',
        'logout': '/logout',
        'login': '/login',
        'register': '/register',
        'marketplace': '/marketplace',
        'wishlist': '/wishlist',
        'reports': '/admin/reports',
        'admin dashboard': '/admin/dashboard',
        'settings': '/profile',
        'chat': '/chats',
        'inbox': '/chats',
        'help': '/help'
    };
    
    // Find best matching command
    let matchedRoute = null;
    let matchedCommand = null;
    
    for (const [key, route] of Object.entries(commands)) {
        if (command.includes(key)) {
            matchedRoute = route;
            matchedCommand = key;
            break;
        }
    }
    
    if (matchedRoute) {
        document.getElementById('voice-status').textContent = "Executing: " + matchedCommand;
        setTimeout(() => {
            window.location.href = matchedRoute;
        }, 1000);
    } else {
        document.getElementById('voice-status').textContent = "Command not recognized: " + command;
        setTimeout(() => {
            document.getElementById('voice-status').textContent = "Ready to listen...";
        }, 2000);
    }
}

// Make it globally available
window.voiceAgent = voiceAgent;

document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal') && e.target.classList.contains('fade')) {
        stopVoiceRecognition();
    }
});

</script>

</script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Persistent theme using localStorage (run after DOM ready)
      document.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('theme') || 'light';
        setTheme(savedTheme);

        // Auto remove flash messages after 3 seconds (instant remove, no fade)
        setTimeout(() => {
          const flashContainer = document.getElementById("flash-container");
          if (flashContainer) flashContainer.remove();
        }, 1000);
      });

      function setTheme(mode) {
        if (mode === 'dark') {
          document.body.classList.add('dark-mode');
          const t = document.querySelector('.theme-toggle');
          if (t) t.textContent = '‚òÄÔ∏è';
        } else {
          document.body.classList.remove('dark-mode');
          const t = document.querySelector('.theme-toggle');
          if (t) t.textContent = 'üåô';
        }
        localStorage.setItem('theme', mode);
      }

      function toggleTheme() {
        if (document.body.classList.contains('dark-mode')) {
          setTheme('light');
        } else {
          setTheme('dark');
        }
      }
    </script>
  </body>
</html>
