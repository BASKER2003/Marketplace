{% extends 'base.html' %}
{% block content %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>
  .wish-card { border-radius:12px; overflow:hidden; transition:.2s; }
  .wish-card:hover { transform: translateY(-5px); box-shadow:0 12px 30px rgba(0,0,0,0.15); }

  .card-img-top { height:220px; object-fit:cover; background:#f8f8f8; }

  .wishlist-btn i { font-size:20px; cursor:pointer; }
  .bi-heart-fill { color:#d30000 !important; }

  .modal-img { width:100%; height:60vh; object-fit:contain; background:#000; }

  @media(max-width:768px){
    .card-img-top { height:160px; }
    .modal-img { height:45vh; }
  }
</style>

<div class="container py-4">

  <h2 class="fw-bold text-center mb-4">
    <i class="bi bi-heart text-danger"></i> Your Wishlist
    <a class="w-bold btn btn-outline-primary float-end" href="{{ url_for('dashboard') }}"><i class="bi bi-arrow-left me-2"></i> Back to Dashboard</a>
  </h2>

  <!-- empty message -->
  <div id="emptyMessage" class="{% if wishlist_items|length > 0 %}d-none{% endif %} text-center text-muted py-5">
      <i class="bi bi-heart fs-1"></i>
      <p class="mt-2">No items in wishlist yet</p>
      <a href="{{ url_for('marketplace') }}" class="btn btn-primary mt-3">
        <i class="bi bi-shop"></i> Browse Marketplace
      </a>
  </div>

  <div class="row mt-4 g-4" id="wishlistContainer">

    {% for item in wishlist_items %}
    <div class="col-lg-4 col-md-6 item-card" id="item-card-{{ item.id }}">

      <div class="card wish-card h-100">

        <!-- image -->
        <div data-bs-toggle="modal" data-bs-target="#modal{{ item.id }}" style="cursor:pointer;">
          {% if item.images %}
            <img src="{{ url_for('static', filename='uploads/items/' ~ item.images[0]) }}" class="card-img-top">
          {% else %}
            <div class="card-img-top d-flex align-items-center justify-content-center text-muted">No Image</div>
          {% endif %}
        </div>

        <div class="card-body d-flex flex-column">

          <h5 class="fw-semibold text-truncate">{{ item.title }}</h5>
          <div class="small text-muted text-truncate">{{ item.description }}</div>

          <span class="badge bg-secondary">{{ item.category }}</span>

          <div class="mt-3 d-flex justify-content-between">
            {% if item.price == 0 %}
              <span class="badge bg-success">FREE</span>
            {% else %}
              <span class="fw-bold">{{ item.currency }} {{ '%.2f'|format(item.price) }}</span>
            {% endif %}
            <span class="text-muted small">Posted {{ item.posted_clean }}</span>
          </div>

          <div class="d-flex gap-2 mt-3">

            <button class="btn btn-outline-primary btn-sm flex-fill"
              data-bs-toggle="modal" data-bs-target="#modal{{ item.id }}">
              <i class="bi bi-eye"></i> View
            </button>

            <!-- HEART TOGGLE -->
            <button class="btn btn-light btn-sm wishlist-btn"
                    data-item-id="{{ item.id }}">
              <i class="bi bi-heart-fill text-danger"></i>
            </button>

            <a href="{{ url_for('start_chat', other_user_id=item.owner_id) }}"
               class="btn btn-outline-success btn-sm">
              <i class="bi bi-chat-left-text"></i>
            </a>
          </div>

        </div>

      </div>
    </div>

    <!-- MODAL -->
    <div class="modal fade" id="modal{{ item.id }}" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">

          <div class="modal-header">
            <h5 class="modal-title">{{ item.title }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">

            <div class="row g-3">

              <div class="col-md-7">
                {% if item.images|length > 1 %}
                  <div id="carousel{{ item.id }}" class="carousel slide">
                    <div class="carousel-inner">
                      {% for img in item.images %}
                      <div class="carousel-item {% if loop.first %}active{% endif %}">
                        <img src="{{ url_for('static', filename='uploads/items/' ~ img) }}" class="modal-img">
                      </div>
                      {% endfor %}
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#carousel{{ item.id }}" data-bs-slide="prev">
                      <span class="carousel-control-prev-icon"></span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#carousel{{ item.id }}" data-bs-slide="next">
                      <span class="carousel-control-next-icon"></span>
                    </button>
                  </div>
                {% elif item.images %}
                  <img src="{{ url_for('static', filename='uploads/items/' ~ item.images[0]) }}" class="modal-img">
                {% else %}
                  <div class="text-muted text-center" style="height:300px;border:1px dashed #999;">
                    No Images
                  </div>
                {% endif %}
              </div>

              <div class="col-md-5">

                <p><strong>Category:</strong> {{ item.category }}</p>

                <p><strong>Price:</strong>
                  {% if item.price == 0 %}
                    <span class="text-success fw-bold">FREE</span>
                  {% else %}
                    <span class="fw-bold">{{ item.currency }} {{ '%.2f'|format(item.price) }}</span>
                  {% endif %}
                </p>

                <p><strong>Description:</strong></p>
                <p class="text-muted">{{ item.description }}</p>

                <div class="d-grid gap-2 mt-3">

                  <!-- REMOVE FROM WISHLIST -->
                  <button class="btn btn-danger wishlist-btn"
                          data-item-id="{{ item.id }}">
                    <i class="bi bi-heart-fill"></i> Remove from Wishlist
                  </button>

                  <a href="{{ url_for('contact_seller', item_id=item.id) }}"
                     class="btn btn-success">
                    <i class="bi bi-chat"></i> Contact Seller
                  </a>

                  <a class="w-bold btn btn-outline-primary float-end" href="{{ url_for('wishlist') }}">
                    <i class="bi bi-arrow-left me-2"></i> Back
                  </a>

                </div>

              </div>

            </div>

          </div>

        </div>
      </div>
    </div>

    {% endfor %}
  </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const wishlistContainer = document.getElementById("wishlistContainer");
    const emptyMessage = document.getElementById("emptyMessage");

    document.querySelectorAll(".wishlist-btn").forEach(btn => {

        btn.addEventListener("click", function () {

            let id = this.dataset.itemId;
            let icon = this.querySelector("i");

            fetch("{{ url_for('wishlist_toggle') }}", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: "item_id=" + id
            })
            .then(r => r.json())
            .then(data => {

                if (data.status === "removed") {

                    // remove modal
                    let modal = bootstrap.Modal.getInstance(
                        document.getElementById("modal" + id)
                    );
                    modal?.hide();

                    // remove card from UI
                    let card = document.getElementById("item-card-" + id);
                    if (card) {
                        card.style.opacity = "0";
                        setTimeout(() => card.remove(), 250);
                    }

                    // show empty message if none left
                    if (document.querySelectorAll(".item-card").length <= 1) {
                        emptyMessage.classList.remove("d-none");
                    }
                }

                // toggle icon
                icon.classList.toggle("bi-heart-fill");
                icon.classList.toggle("bi-heart");
            });

        });
    });

});
</script>

{% endblock %}
