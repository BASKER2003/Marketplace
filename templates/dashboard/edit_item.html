{% extends 'base.html' %}
{% block content %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<div class="container py-4">
    <h2 class="fw-bold text-center mb-4"><i class="bi bi-pencil-square"></i> Edit Item
    <a class="w-bold btn btn-outline-primary float-end" href="{{ url_for('my_listings') }}"><i class="bi bi-arrow-left me-2"></i> Back to Listings</a>
    </h2>

    <form method="POST" enctype="multipart/form-data">

        <!-- TITLE & DESCRIPTION -->
        <div class="mb-3">
            <label class="form-label">Title</label>
            <input type="text" name="title" class="form-control" value="{{ item['title'] }}" required>
        </div>

        <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea name="description" class="form-control" rows="4" required>{{ item['description'] }}</textarea>
        </div>

        <!-- PRICE, CURRENCY & FREE -->
        <div class="row mb-3">
            <div class="col-md-4">
                <label class="form-label">Price</label>
                <input type="number" step="0.01" name="price" class="form-control" value="{{ item['price'] }}">
            </div>
            <div class="col-md-4">
                <label class="form-label">Currency</label>
                <select name="currency" class="form-select" id="currencySelect">
                    <option value="INR" {% if item['currency'] == 'INR' %}selected{% endif %}>INR</option>
                    <option value="EURO" {% if item['currency'] == 'EURO' %}selected{% endif %}>EUR</option>
                    <option value="GBP" {% if item['currency'] == 'GBP' %}selected{% endif %}>GBP</option>
                </select>
            </div>

            <div class="col-md-4 d-flex align-items-center">
                <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" name="is_free" id="isFree"
                        {% if item['price'] == 0 %}checked{% endif %}>
                    <label class="form-check-label">Free</label>
                </div>
            </div>
        </div>

        <!-- POSTED DATE & EXPIRY DATE -->
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">Posted Date</label>
                <input type="date" name="posted_date" class="form-control" value="{{ item['posted_date'][:10] }}" required>
            </div>
            <div class="col-md-6">
                <label class="form-label">Expiry Date</label>
                <input type="date" name="expires_at" class="form-control" value="{{ item['expires_at'][:10] }}" required>
            </div>
        </div>

        <!-- EXISTING IMAGES -->
        {% if images %}
        <div class="mb-3">
            <label class="form-label">Existing Images</label>
            <div class="row g-2">
                {% for img in images %}
                <div class="col-4 position-relative text-center">
                    <img src="{{ url_for('static', filename='uploads/items/' ~ img['filename']) }}"
                         class="img-fluid rounded border">
                    <div class="form-check position-absolute top-0 end-0 m-1">
                        <input class="form-check-input" type="checkbox" name="delete_images" value="{{ img['id'] }}">
                        <label class="form-check-label text-white bg-dark px-1 rounded">Del</label>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- NEW IMAGES -->
        <div class="mb-3">
            <label class="form-label">Add New Images (Max 5 total)</label>
            <input type="file" name="new_images" id="newImages" multiple class="form-control"
                   data-existing-images="{{ images|length }}">
            <small class="text-muted">You can upload up to {{ 5 - images|length }} more images.</small>
        </div>

        <button type="submit" class="btn btn-primary w-100"><i class="bi bi-save"></i> Update Item</button>
        
    </form>
</div>

<script>
const newImagesInput = document.getElementById('newImages');
const existingCount = parseInt(newImagesInput.dataset.existingImages);

newImagesInput.addEventListener('change', function() {
    const remaining = 5 - existingCount;
    if (this.files.length > remaining) {
        alert(`You can upload only ${remaining} more images.`);
        this.value = '';
    }
});

// Handle "Free" checkbox behavior
const priceInput = document.querySelector('input[name="price"]');
const currencyInput = document.querySelector('input[name="currency"]');
const freeCheckbox = document.getElementById('isFree');
const currencySelect = document.getElementById('currencySelect');


freeCheckbox.addEventListener('change', function() {
    if(this.checked){
        priceInput.value = 0;
        currencySelect.value = '';
        priceInput.disabled = true;
        currencySelect.disabled = true;
    } else {
        priceInput.disabled = false;
        currencySelect.disabled = false;
    }
});

// Initialize on page load
if(freeCheckbox.checked){
    priceInput.disabled = true;
    currencySelect.disabled = true;
}



</script>

{% endblock %}
