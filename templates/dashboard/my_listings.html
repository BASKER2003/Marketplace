{% extends 'base.html' %}
{% block content %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>
/* ===== CARD STYLES ===== */
.item-card {
    border-radius: 16px;
    overflow: hidden;
    background: #fff;
    box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    transition: 0.3s;
    display: flex;
    flex-direction: column;
    height: 100%;
}
.item-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 14px 28px rgba(0,0,0,0.25);
}

/* DARK MODE */
body.dark-mode .item-card {
    background: #1e1e1e;
    color: #f0f0f0;
}
body.dark-mode .item-title,
body.dark-mode .item-desc,
body.dark-mode .text-muted,
body.dark-mode .price {
    color: #f0f0f0 !important;
}

/* CARD CONTENT */
.item-title {
    font-size: 1.25rem;
    font-weight: 700;
}
.item-desc {
    font-size: 0.95rem;
    max-height: 65px;
    overflow: hidden;
    color: #555;
}


.desc-text {
    display: block;
    white-space: pre-wrap;
    max-height: 65px;
    overflow: hidden;
    line-height: 1.4;
}

.desc-text.expanded {
    max-height: none;
    white-space: normal;
}

.toggle-desc {
    color: #0d6efd;
    text-decoration: none;
    font-weight: 600;
    margin-left: 5px;
}


/* CATEGORY BADGE */
.item-category {
    font-size: 0.8rem;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 12px;
}

/* ===== Carousel Controls Dark Theme ===== */
.carousel-control-prev-icon,
.carousel-control-next-icon {
    background-color: rgba(0,0,0,0.6); /* dark background */
    border-radius: 50%;                 /* circle */
    width: 40px;
    height: 40px;
    background-size: 100%, 100%;
}

/* Adjust position for modal carousel controls */
.modal .carousel-control-prev,
.modal .carousel-control-next {
    top: 50%;
    transform: translateY(-50%);
}

/* CAROUSEL */
.carousel-item img {
    width: 100%;
    object-fit: contain;
    cursor: pointer;
} 

/* ===== Modal Image Proper Fit ===== */
.modal-img {
    width: 100%;
    height: auto;          /* Maintain aspect ratio */
    max-height: 80vh;      /* Max height relative to viewport */
    object-fit: contain;   /* Scale to fit without cropping */
}



@media (max-width: 768px) {
    .carousel-item img { height: 200px; }
}
@media (min-width: 769px) {
    .carousel-item img { height: 240px; }
}


/* BUTTONS */
.btn-edit { background: #0d6efd; color: #fff; font-weight: 600; }
.btn-edit:hover { background: #0b5ed7; }
.btn-delete { background: #d62828; color: #fff; font-weight: 600; }
.btn-delete:hover { background: #b11f1f; }

/* BADGES */
.badge-active { background: #28a745; }
.badge-expired { background: #dc3545; }
.badge-free { background: #00b894; }
.badge-scheduled { background: #ffc107; color: #212529; }

/* CARD DETAILS SPACING */
.item-card .card-content-wrapper {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    padding: 1rem;
}
.card-footer {
    margin-top: auto;
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

/* RESPONSIVE BUTTONS */
@media(max-width: 576px) {
    .btn-edit, .btn-delete { width: 100%; }
}
</style>

<div class="container py-4">

    <h2 class="fw-bold text-center mb-4">
        <i class="bi bi-box-seam"></i> My Listings
        <a class="w-bold btn btn-outline-primary float-end" href="{{ url_for('dashboard') }}"><i class="bi bi-arrow-left me-2"></i> Back to Dashboard</a>
    </h2>


    {% if items %}
    <div class="row g-4">
        {% for item in items %}
        <div class="col-xl-4 col-lg-6 col-md-6 col-sm-12 d-flex">
            <div class="item-card w-100">

                <!-- IMAGE / CAROUSEL -->
                {% if item.images|length > 1 %}
                <div id="carousel{{ item.id }}" class="carousel slide" data-bs-ride="carousel" data-bs-interval="3000">
                    <div class="carousel-inner">
                        {% for img in item.images %}
                        <div class="carousel-item {% if loop.first %}active{% endif %}">
                            <img src="{{ url_for('static', filename='uploads/items/' ~ img) }}" 
                                 onclick="openModal('{{ item.id }}')">
                        </div>
                        {% endfor %}
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#carousel{{ item.id }}" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon"></span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#carousel{{ item.id }}" data-bs-slide="next">
                        <span class="carousel-control-next-icon"></span>
                    </button>
                </div>
                {% else %}
                <img src="{{ url_for('static', filename='uploads/items/' ~ item.thumbnail) }}" 
                     class="w-100" style="height:240px; object-fit:cover; cursor:pointer;"
                     onclick="openModal('{{ item.id }}')">
                {% endif %}

                <!-- DETAILS -->
                <div class="card-content-wrapper">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="item-title">{{ item.title }}</span>
                        <span class="item-category badge bg-info">{{ item.category }}</span>
                    </div>

                        <div class="item-desc mb-2">
    <span class="desc-text" style="white-space: pre-wrap;">{{ item.description }}</span>
    {% if item.description|length > 150 %}
        <button class="btn btn-sm btn-link p-0 toggle-desc" onclick="toggleDescription(this)">
            <small>... Show more</small>
        </button>
    {% endif %}
</div>

                    <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap">
                        {% if item.price == 0 %}
                        <span class="badge badge-free px-3 py-2">FREE</span>
                        {% else %}
                        <span class="price fw-bold text-dark">{{ item.price }} {{ item.currency }}</span>
                        {% endif %}

                        {% if item.status == 'active' %}
                        <span class="badge badge-active px-3 py-2 mt-2 mt-sm-0">Active</span>
                        {% elif item.status == 'expired' %}
                        <span class="badge badge-expired px-3 py-2 mt-2 mt-sm-0">Expired</span>
                        {% elif item.status == 'scheduled' %}
                        <span class="badge badge-scheduled px-3 py-2 mt-2 mt-sm-0">Scheduled</span>
                        {% endif %}
                    </div>

                    <small class="text-muted d-block">Posted: {{ item.posted_date_clean }}</small>
                    <small class="text-muted d-block">Expires: {{ item.expires_at_clean }}</small>
                    <br/><br/>
                    <!-- ACTION BUTTONS -->
                    <div class="card-footer">
                        <a href="{{ url_for('edit_item', item_id=item.id) }}" class="btn btn-edit flex-grow-1">
                            <i class="bi bi-pencil"></i> Edit
                        </a>
                        <a href="{{ url_for('delete_item', item_id=item.id) }}" 
                           onclick="return confirm('Delete this item permanently?')" 
                           class="btn btn-delete flex-grow-1">
                            <i class="bi bi-trash"></i> Delete
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL -->
        <div class="modal fade" id="modal{{ item.id }}" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content bg-dark text-white">
                    <div class="modal-header border-0">
                        <h5>{{ item.title }}</h5>
                        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="modalCarousel{{ item.id }}" class="carousel slide" data-bs-ride="carousel">
                            <div class="carousel-inner">
                                {% for img in item.images %}
                                <div class="carousel-item {% if loop.first %}active{% endif %}">
                                    <img src="{{ url_for('static', filename='uploads/items/' ~ img) }}" class="modal-img">
                                </div>
                                {% endfor %}
                            </div>
                            {% if item.images|length > 1 %}
                            <button class="carousel-control-prev" type="button" data-bs-target="#modalCarousel{{ item.id }}" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon"></span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#modalCarousel{{ item.id }}" data-bs-slide="next">
                                <span class="carousel-control-next-icon"></span>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% endfor %}
    </div>

    {% else %}
    <div class="text-center py-5">
        <h4>No listings found.</h4>
        <a href="{{ url_for('add_item') }}" class="btn btn-primary btn-lg mt-3">
            <i class="bi bi-plus-circle"></i> Add New Listing
        </a>
    </div>
    {% endif %}
</div>

<script>
function openModal(id) {
    const modal = new bootstrap.Modal(document.getElementById("modal" + id));
    modal.show();
}

function toggleDescription(button) {
    const descText = button.previousElementSibling;
    const isExpanded = descText.classList.contains('expanded');
    
    if (isExpanded) {
        descText.classList.remove('expanded');
        button.innerHTML = '<small>... Show more</small>';
    } else {
        descText.classList.add('expanded');
        button.innerHTML = '<small>Show less</small>';
    }
}

</script>

{% endblock %}
